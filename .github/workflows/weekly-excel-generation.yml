name: Comprehensive Weekly Excel Generation with Enhanced Sentry Monitoring

on:
  schedule:
    # Run weekly on Sunday at 11 PM CST (Monday 5 AM UTC) for weekly report generation
    # This ensures reports capture the complete work week (Monday-Sunday)
    - cron: '0 5 * * 1'   # Weekly on Monday at 5 AM UTC (Sunday 11 PM CST)
  
  # Allow manual triggering for testing and immediate report generation
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (true/false) - Production mode will upload to Smartsheet'
        required: false
        default: 'false'
        type: choice
        options:
        - 'false'
        - 'true'
      force_generation:
        description: 'Force generate reports even if no eligible data found'
        required: false
        default: 'false'
        type: choice
        options:
        - 'false'
        - 'true'
      enable_ai_analysis:
        description: 'Enable AI analysis and insights (may increase runtime)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'false'
        - 'true'

env:
  # Central Time Zone for logging purposes
  TZ: America/Chicago

jobs:
  comprehensive-excel-generation:
    runs-on: ubuntu-latest
    
    # Optimized timeout for comprehensive system with enhanced monitoring
    timeout-minutes: 25  # Allows sufficient time for complete processing with Sentry monitoring
    
    # Environment variables for comprehensive system
    env:
      PYTHONUNBUFFERED: 1
      TF_CPP_MIN_LOG_LEVEL: 3  # Suppress TensorFlow warnings for cleaner logs
      OMP_NUM_THREADS: 4       # Optimize for 4-core GitHub runner
      OPENBLAS_NUM_THREADS: 4  # Optimize NumPy operations for CPU
      # Production system control variables
      GITHUB_ACTIONS: 'true'
      ENABLE_HEAVY_AI: ${{ github.event.inputs.enable_ai_analysis || 'false' }}
      SKIP_CELL_HISTORY: 'true'  # API resilience - skip problematic calls in GitHub Actions
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Python Environment
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Cache Python Dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-comprehensive-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-comprehensive-
          ${{ runner.os }}-pip-
        
    - name: Install System Dependencies
      run: |
        echo "üîß Installing Comprehensive Excel Generation System Dependencies..."
        python -m pip install --upgrade pip
        
        # Install based on AI mode preference
        if [ "${{ github.event.inputs.enable_ai_analysis }}" = "true" ]; then
          echo "üß† Full Mode: Installing complete system with AI capabilities"
          pip install -r requirements.txt
          echo "‚úÖ Full System Installed:"
          echo "   ‚Ä¢ Complete Excel generation with enhanced formatting"
          echo "   ‚Ä¢ Advanced error monitoring with Sentry integration"
          echo "   ‚Ä¢ AI-powered insights and anomaly detection"
          echo "   ‚Ä¢ Comprehensive grouping logic validation"
        else
          echo "‚ö° Standard Mode: Installing optimized dependencies for maximum reliability"
          pip install -r requirements-ultralight.txt
          
          echo "‚úÖ Standard System Installed:"
          echo "   ‚Ä¢ Essential Excel generation and Smartsheet integration"
          echo "   ‚Ä¢ Enhanced Sentry monitoring with detailed error context"
          echo "   ‚Ä¢ Critical grouping logic validation and protection"
          echo "   ‚Ä¢ Optimized for reliability and speed"
        fi
        
        # Verify core system components
        python -c "import sentry_sdk; print('‚úÖ Sentry monitoring ready')"
        python -c "import smartsheet; print('‚úÖ Smartsheet integration ready')"
        python -c "import openpyxl; print('‚úÖ Excel generation ready')"
        
    - name: Verify System Time and Execution Context
      run: |
        echo "Current UTC time: $(date -u)"
        echo "Current Central time: $(TZ=America/Chicago date)"
        echo "Execution mode: Weekly comprehensive Excel generation"
        
    - name: Check Execution Conditions
      id: execution_check
      run: |
        # Get current time info in Central Time
        current_day=$(TZ=America/Chicago date +%w)
        current_hour=$(TZ=America/Chicago date +%H)
        current_date=$(TZ=America/Chicago date +%Y-%m-%d)
        
        echo "Current day of week: $current_day (0=Sunday, 1=Monday)"
        echo "Current hour (Central): $current_hour"
        echo "Current date: $current_date"
        
        # Execution logic for comprehensive system
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "üîß Manual trigger - executing comprehensive generation"
          echo "should_run=true" >> $GITHUB_OUTPUT
        else
          echo "‚è∞ Scheduled execution - weekly comprehensive generation"
          echo "should_run=true" >> $GITHUB_OUTPUT
        fi
        
        echo "run_id=$(date +%Y%m%d-%H%M)" >> $GITHUB_OUTPUT
        
    - name: Set Production Mode
      if: steps.execution_check.outputs.should_run == 'true' && github.event.inputs.test_mode != 'true'
      run: |
        # Set TEST_MODE to False for production runs
        sed -i 's/TEST_MODE = True/TEST_MODE = False/' generate_weekly_pdfs.py
        echo "‚úÖ Set to PRODUCTION mode - files will be generated and uploaded to Smartsheet"
        echo "üîç Enhanced Sentry monitoring active for production error tracking"
        
    - name: Keep Test Mode
      if: github.event.inputs.test_mode == 'true'
      run: |
        echo "üß™ Keeping TEST_MODE = True for test run"
        echo "Files will be generated locally but NOT uploaded to Smartsheet"
        echo "üîç Sentry monitoring will track test execution for debugging"
        
    - name: Comprehensive Weekly Excel Generation with Enhanced Sentry Monitoring
      if: steps.execution_check.outputs.should_run == 'true'
      env:
        # GitHub Secrets - DO NOT put actual values here
        SMARTSHEET_API_TOKEN: ${{ secrets.SMARTSHEET_API_TOKEN }}
        SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        # System configuration
        GITHUB_ACTIONS: 'true'
        ENABLE_HEAVY_AI: ${{ github.event.inputs.enable_ai_analysis || 'false' }}
        SKIP_CELL_HISTORY: 'true'  # Skip cell history API calls for reliability
        ENVIRONMENT: 'production'
        RELEASE: ${{ github.sha }}
        FORCE_GENERATION: ${{ github.event.inputs.force_generation || 'false' }}
      run: |
        echo "üîç Starting Comprehensive Weekly Excel Generation System..."
        echo "===================================================================================="
        echo "üéØ ENHANCED SYSTEM FEATURES:"
        echo "   ‚Ä¢ Advanced Sentry monitoring with detailed line-specific error reporting"
        echo "   ‚Ä¢ Critical grouping logic validation and protection"
        echo "   ‚Ä¢ Professional Excel generation with enhanced formatting"
        echo "   ‚Ä¢ Bulletproof one-work-request-per-file grouping enforcement"
        echo "   ‚Ä¢ Real-time error detection with exact source location tracking"
        echo ""
        echo "üîí CRITICAL BUSINESS LOGIC PROTECTION:"
        echo "   ‚Ä¢ Each Excel file contains ONLY one work request per week ending date"
        echo "   ‚Ä¢ Comprehensive validation prevents grouping logic regression"
        echo "   ‚Ä¢ Immediate Sentry alerting for any violations of business rules"
        echo "   ‚Ä¢ Enhanced debugging with exact line numbers and context"
        echo ""
        echo "üìä SYSTEM ARCHITECTURE:"
        echo "   ‚Ä¢ Phase 1: Secure data discovery with API resilience"
        echo "   ‚Ä¢ Phase 2: Protected grouping with real-time validation"
        echo "   ‚Ä¢ Phase 3: Professional Excel generation with monitoring"
        echo "   ‚Ä¢ Phase 4: Smartsheet upload with comprehensive error tracking"
        echo ""
        echo "Current execution time: $(TZ=America/Chicago date)"
        
        # Verify required secrets
        if [ -z "$SMARTSHEET_API_TOKEN" ]; then
          echo "‚ùå ERROR: SMARTSHEET_API_TOKEN secret not found"
          echo "Please add your Smartsheet API token as a repository secret"
          echo "Go to: Repository Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
          echo "Name: SMARTSHEET_API_TOKEN"
          echo "Value: [Your Smartsheet API token]"
          exit 1
        fi
        
        if [ -z "$SENTRY_DSN" ]; then
          echo "‚ö†Ô∏è WARNING: SENTRY_DSN secret not found"
          echo "Enhanced error monitoring will be disabled"
          echo "To enable full monitoring capabilities:"
          echo "1. Create a Sentry account at https://sentry.io"
          echo "2. Create a new project for error monitoring"
          echo "3. Copy the DSN from your Sentry project settings"
          echo "4. Add SENTRY_DSN as a GitHub repository secret"
          echo "Go to: Repository Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
          echo "Name: SENTRY_DSN"
          echo "Value: [Your Sentry DSN URL]"
        else
          echo "‚úÖ SENTRY_DSN configured - Enhanced error monitoring with line-specific reporting enabled"
        fi
        
        # Execute the comprehensive system
        echo "üöÄ Executing Comprehensive Excel Generation System..."
        echo "üìã Running with enhanced Sentry monitoring and grouping logic protection"
        
        # Run the main system with comprehensive monitoring
        python generate_weekly_pdfs.py
        
        # Log completion with comprehensive summary
        echo "‚úÖ Comprehensive Excel generation system completed at $(TZ=America/Chicago date)"
        echo "üîç MONITORING: Enhanced Sentry tracking with detailed error context"
        echo "üìä EXCEL: Professional reports with protected grouping logic"
        echo "üõ°Ô∏è VALIDATION: Critical business rules monitored and enforced"
        echo "‚ö° RELIABILITY: Optimized for GitHub Actions stability"
        
    - name: Upload Generated Excel Reports
      if: always() && steps.execution_check.outputs.should_run == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: comprehensive-excel-reports-${{ github.run_number }}
        path: generated_docs/
        retention-days: 30
        
    - name: Log Comprehensive System Execution Summary
      if: always()
      run: |
        echo "üéØ COMPREHENSIVE EXCEL GENERATION SYSTEM SUMMARY"
        echo "=================================================="
        echo "Trigger: ${{ github.event_name }}"
        echo "Time: $(TZ=America/Chicago date)"
        echo "Should run: ${{ steps.execution_check.outputs.should_run }}"
        echo "Test mode: ${{ github.event.inputs.test_mode }}"
        echo "AI Analysis: ${{ github.event.inputs.enable_ai_analysis }}"
        echo ""
        echo "üöÄ COMPREHENSIVE SYSTEM FEATURES EXECUTED:"
        echo "‚úÖ ENHANCED SENTRY: Line-specific error reporting with detailed context"
        echo "‚úÖ GROUPING PROTECTION: Critical business logic validation and monitoring"
        echo "‚úÖ EXCEL GENERATION: Professional reports with advanced formatting"
        echo "‚úÖ SMARTSHEET INTEGRATION: Reliable uploads with error resilience"
        echo "‚úÖ REAL-TIME MONITORING: Immediate alerts for any system violations"
        echo "‚ö° Performance: Optimized for GitHub Actions reliability and speed"
        echo ""
        
        if [ -d "generated_docs" ]; then
          echo "üìÅ Comprehensive system generated files:"
          file_count=$(find generated_docs/ -name "*.xlsx" -type f | wc -l)
          echo "   üìä Excel Reports: $file_count (with enhanced Sentry monitoring)"
          echo "   üîç Grouping Validation: Protected against business logic regression"
          echo "   üéØ Error Tracking: Detailed line-specific debugging information"
          echo "   üõ°Ô∏è Business Rules: Enforced with real-time monitoring"
          ls -la generated_docs/ 2>/dev/null || echo "Directory access limited"
        else
          echo "‚ùå No generated_docs directory found - check system execution"
        fi
        
        echo ""
        echo "üîí BUSINESS LOGIC PROTECTION: One work request per Excel file enforced"
        echo "üöÄ PRODUCTION READY: Comprehensive monitoring and error tracking enabled"

    - name: Skip Execution
      if: steps.execution_check.outputs.should_run != 'true' && github.event_name != 'workflow_dispatch'
      run: |
        echo "‚è≠Ô∏è No execution needed at this time"
        echo "System runs weekly to generate comprehensive Excel reports"
