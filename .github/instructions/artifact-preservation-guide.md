# Artifact Preservation & Retrieval Guide

This guide explains the comprehensive artifact preservation system for Excel billing reports generated by the GitHub Actions workflow.

## Overview

Every workflow run generates Excel billing reports that are automatically preserved in GitHub's secure cloud storage as **artifacts**. These artifacts are organized for easy discovery, include comprehensive metadata, and are retained with appropriate security policies.

## Artifact Organization Structure

### 1. Complete Bundle Artifact
**Name Format**: `Excel-Reports-Complete-{execution_type}-Run{number}`

**Contains**:
- All generated Excel files (WR_*.xlsx)
- Artifact manifest (artifact_manifest.json)
- Hash history (hash_history.json)
- Audit state (audit_state.json)

**Purpose**: Single download with everything from the workflow run

**Example**: `Excel-Reports-Complete-production_frequent-Run1234`

### 2. By Work Request Artifact
**Name Format**: `By-WorkRequest-{execution_type}-Run{number}`

**Structure**:
```
by_wr/
├── WR_90093002/
│   ├── WR_90093002_WeekEnding_081725_163045_a4d1aae7.xlsx
│   └── WR_90093002_WeekEnding_082425_163045_b7e2ccf9.xlsx
├── WR_89979435/
│   └── WR_89979435_WeekEnding_092825_163045_3f8d9be1.xlsx
└── ...
```

**Purpose**: Easy access to all reports for a specific Work Request across all weeks

### 3. By Week Ending Artifact
**Name Format**: `By-WeekEnding-{execution_type}-Run{number}`

**Structure**:
```
by_week/
├── Week_081725/
│   ├── WR_90093002_WeekEnding_081725_163045_a4d1aae7.xlsx
│   └── WR_89954686_WeekEnding_081725_163045_c2f5aab3.xlsx
├── Week_092825/
│   └── WR_89979435_WeekEnding_092825_163045_3f8d9be1.xlsx
└── ...
```

**Purpose**: Easy access to all Work Requests for a specific billing week

### 4. Manifest Artifact
**Name Format**: `Manifest-{execution_type}-Run{number}`

**Contains**: `artifact_manifest.json` with comprehensive metadata:
- File list with SHA256 hashes for validation
- File sizes and timestamps
- Organized by Work Request and Week Ending
- Summary statistics

**Purpose**: Audit trail, file validation, programmatic access

## File Naming Convention

All Excel files follow a strict naming convention for clarity and traceability:

```
WR_{work_request}_WeekEnding_{MMDDYY}_{timestamp}_{hash}.xlsx
```

**Components**:
- `work_request`: Work Request number (e.g., 90093002)
- `MMDDYY`: Week ending date in month/day/year format
- `timestamp`: Generation timestamp (HHMMSS format)
- `hash`: 8-character data hash for change detection

**Examples**:
- `WR_90093002_WeekEnding_081725_163045_a4d1aae7.xlsx`
- `WR_89979435_WeekEnding_092825_142301_3f8d9be1.xlsx`

**Benefits**:
- ✅ Human-readable and sortable
- ✅ No binary/random names
- ✅ Self-documenting (WR number and week visible)
- ✅ Unique per generation (timestamp + hash)
- ✅ Easy filtering and searching

## Execution Types

Artifacts are tagged with execution type for context:

| Execution Type | Description | Frequency |
|----------------|-------------|-----------|
| `production_frequent` | Weekday production runs | Every 2 hours (M-F) |
| `weekend_maintenance` | Weekend runs | 4 times daily (Sat-Sun) |
| `weekly_comprehensive` | Full weekly audit | Monday 11PM |
| `manual` | Manual workflow dispatch | On-demand |

## Retention Policy

| Artifact Type | Test Mode | Production Mode |
|---------------|-----------|-----------------|
| Complete Bundle | 30 days | 90 days (max) |
| By Work Request | 30 days | 90 days (max) |
| By Week Ending | 30 days | 90 days (max) |
| Manifest | 90 days | 90 days (max) |

**Notes**:
- Maximum GitHub retention is 90 days (repository setting)
- Manifests always kept for 90 days for audit trail
- Test runs use shorter retention to conserve storage

## Security & Access Control

### Authentication
- **Required**: GitHub authentication to access artifacts
- **Access Level**: Repository read permissions minimum
- **Security**: Artifacts encrypted at rest by GitHub

### Validation
- **SHA256 Hashes**: Every file has a SHA256 digest for validation
- **Automatic Verification**: GitHub validates artifact integrity on download
- **Manifest Check**: Compare downloaded file hash against manifest

### Best Practices
- ✅ Download artifacts through GitHub UI or API
- ✅ Verify SHA256 hashes for critical files
- ✅ Use manifest JSON for programmatic access
- ❌ Do not share artifact URLs publicly (require authentication)

## How to Access Artifacts

### Via GitHub Web UI

1. **Navigate to Workflow Run**:
   - Go to Actions → Weekly Excel Generation
   - Click on specific workflow run

2. **Scroll to Artifacts Section**:
   - Found at bottom of workflow run page
   - Lists all artifacts with sizes and names

3. **Download**:
   - Click artifact name to download as ZIP
   - Extract ZIP to access files

### Via GitHub CLI

```bash
# List artifacts for a workflow run
gh run view <run-id> --repo owner/repo

# Download specific artifact
gh run download <run-id> --name "Excel-Reports-Complete-production_frequent-Run1234"

# Download all artifacts from a run
gh run download <run-id>
```

### Via GitHub API

```bash
# List artifacts
curl -H "Authorization: token $GITHUB_TOKEN" \
  https://api.github.com/repos/owner/repo/actions/runs/<run-id>/artifacts

# Download artifact
curl -L -H "Authorization: token $GITHUB_TOKEN" \
  -H "Accept: application/vnd.github+json" \
  https://api.github.com/repos/owner/repo/actions/artifacts/<artifact-id>/zip \
  -o artifact.zip
```

## Manifest JSON Structure

The `artifact_manifest.json` provides comprehensive metadata:

```json
{
  "generated_at": "2025-09-30T12:34:56",
  "version": "1.0",
  "source_folder": "generated_docs",
  "artifacts": [
    {
      "filename": "WR_90093002_WeekEnding_081725_163045_a4d1aae7.xlsx",
      "filepath": "generated_docs/WR_90093002_WeekEnding_081725_163045_a4d1aae7.xlsx",
      "sha256": "0fde654d4c6e659b45783a725dc92f1bfb0baa6c2de64b34e814dc206ff4aaaf",
      "work_request": "90093002",
      "week_ending": "081725",
      "timestamp": "163045",
      "data_hash": "a4d1aae7",
      "size_bytes": 45678,
      "size_mb": 0.04,
      "created": "2025-09-30T16:30:45",
      "modified": "2025-09-30T16:30:45"
    }
  ],
  "summary": {
    "total_files": 23,
    "total_size_bytes": 1048576,
    "total_size_mb": 1.00,
    "work_requests": ["90093002", "89979435", "..."],
    "week_endings": ["081725", "082425", "..."],
    "by_week": {
      "081725": ["WR_90093002_WeekEnding_081725_...", "..."]
    },
    "by_wr": {
      "90093002": ["WR_90093002_WeekEnding_081725_...", "..."]
    }
  }
}
```

## Use Cases & Workflows

### 1. Retrieve All Reports for a Work Request
```bash
# Download By-WorkRequest artifact
gh run download <run-id> --name "By-WorkRequest-production_frequent-Run1234"

# Navigate to specific WR folder
cd artifact_staging/by_wr/WR_90093002/
```

### 2. Retrieve All Reports for a Billing Week
```bash
# Download By-WeekEnding artifact
gh run download <run-id> --name "By-WeekEnding-production_frequent-Run1234"

# Navigate to specific week folder
cd artifact_staging/by_week/Week_092825/
```

### 3. Validate File Integrity
```bash
# Download manifest
gh run download <run-id> --name "Manifest-production_frequent-Run1234"

# Verify SHA256 hash
manifest_hash=$(jq -r '.artifacts[] | select(.filename=="WR_90093002_WeekEnding_081725_163045_a4d1aae7.xlsx") | .sha256' artifact_manifest.json)
file_hash=$(sha256sum WR_90093002_WeekEnding_081725_163045_a4d1aae7.xlsx | cut -d' ' -f1)

if [ "$manifest_hash" == "$file_hash" ]; then
  echo "✅ File integrity verified"
else
  echo "❌ Hash mismatch!"
fi
```

### 4. Audit Trail & Compliance
The manifest provides a complete audit trail:
- When files were generated
- What data was included (via data hash)
- File sizes and SHA256 for validation
- Organized by business entities (WR, week)

## Storage Efficiency

### Compression
- **Level 6**: Default compression for Excel files (balanced speed/size)
- **Level 9**: Maximum compression for manifest JSON
- **Automatic**: GitHub handles compression/decompression

### Deduplication
- Files with identical content (same data hash) are not regenerated
- Change detection prevents unnecessary artifact creation
- Organized structure prevents duplicate downloads

## Troubleshooting

### Artifact Not Found
- **Check retention period**: Artifacts expire after 30-90 days
- **Verify workflow completion**: Artifacts only created on successful runs
- **Check permissions**: Requires repository read access

### File Hash Mismatch
- **Redownload artifact**: May have been corrupted during download
- **Check extraction**: Ensure ZIP was extracted correctly
- **Contact support**: If persistent, may indicate artifact corruption

### Missing Files in Artifact
- **Check cleanup_only**: If true, no Excel files are generated
- **Review workflow logs**: Check for generation errors
- **Verify WR_FILTER**: May have filtered specific Work Requests

## Integration with Downstream Systems

### Automated Downloads
```python
import requests
import os

def download_latest_artifacts(repo, token):
    """Download latest workflow artifacts."""
    headers = {
        'Authorization': f'token {token}',
        'Accept': 'application/vnd.github+json'
    }
    
    # Get latest workflow run
    runs_url = f'https://api.github.com/repos/{repo}/actions/runs'
    runs = requests.get(runs_url, headers=headers).json()
    latest_run_id = runs['workflow_runs'][0]['id']
    
    # Get artifacts
    artifacts_url = f'https://api.github.com/repos/{repo}/actions/runs/{latest_run_id}/artifacts'
    artifacts = requests.get(artifacts_url, headers=headers).json()
    
    # Download complete bundle
    for artifact in artifacts['artifacts']:
        if artifact['name'].startswith('Excel-Reports-Complete-'):
            download_url = artifact['archive_download_url']
            response = requests.get(download_url, headers=headers)
            
            with open(f"{artifact['name']}.zip", 'wb') as f:
                f.write(response.content)
            
            print(f"✅ Downloaded: {artifact['name']}.zip")
```

## Best Practices

### For Developers
1. ✅ Always check manifest for file list before downloading
2. ✅ Use organized artifacts (By-WR, By-Week) for specific needs
3. ✅ Verify SHA256 hashes for critical financial data
4. ✅ Automate downloads via GitHub API for integration

### For Stakeholders
1. ✅ Download complete bundle for comprehensive view
2. ✅ Use By-WeekEnding for weekly billing cycles
3. ✅ Keep local copies of critical billing periods
4. ✅ Verify file counts against manifest summary

### For Compliance
1. ✅ Manifest provides complete audit trail
2. ✅ SHA256 hashes ensure data integrity
3. ✅ Retention policies align with compliance requirements
4. ✅ Access controls via GitHub authentication

## Support & Questions

For artifact-related issues:
1. Check workflow logs in Actions tab
2. Review manifest JSON for file metadata
3. Verify retention period hasn't expired
4. Contact repository maintainers for assistance

---

**Last Updated**: September 30, 2025  
**Version**: 1.0  
**Related**: `.github/workflows/weekly-excel-generation.yml`, `scripts/generate_artifact_manifest.py`
