
# azure-pipelines.yml
# CI on GitHub; sync GitHub -> Azure DevOps (single-branch or full mirror)

trigger:
  branches:
    include:
      - master     # change to 'main' if your GitHub default is main

pr:
  branches:
    include:
      - master     # change to 'main' if desired

pool:
  vmImage: 'ubuntu-latest'

variables:
  AZDO_ORG: 'LinetecDevelopment'
  AZDO_PROJECT: 'Resiliency - Development'
  AZDO_REPO: 'Generate-Weekly-PDFs-DSR-Resiliency'

steps:
  # Checkout from GitHub (origin points to GitHub)
  - checkout: self
    persistCredentials: true

  - script: |
      set -eu
      git config --global user.name "Azure Pipelines"
      git config --global user.email "buildagent@azuredevops.local"

      echo "Configuring Azure DevOps remote (using System.AccessToken header)..."
      AZDO_URL="https://dev.azure.com/$(AZDO_ORG)/$(AZDO_PROJECT)/_git/$(AZDO_REPO)"

      # Add or update remote named 'azure' WITHOUT credentials in the URL
      if git remote | grep -q '^azure$'; then
        git remote set-url azure "$AZDO_URL"
      else
        git remote add azure "$AZDO_URL"
      fi

      echo "Azure remote set to: $AZDO_URL"
    displayName: 'Configure Git identity & Azure DevOps remote'

  - script: |
      set -eu

      # Ensure weâ€™re up to date with GitHub default branch
      git fetch origin --prune
      git checkout master
      git pull --ff-only origin master

      # Push to Azure DevOps using the OAuth token as an HTTP header
      # (more robust than embedding the token in the URL)
      git -c http.extraheader="AUTHORIZATION: bearer $(System.AccessToken)" \
          push azure master:master
    displayName: 'Sync default branch from GitHub to Azure DevOps'

  # OPTIONAL: Mirror all branches & tags (uncomment if desired)
  # - script: |
  #     set -eu
  #     git fetch origin --prune --tags
  #     git -c http.extraheader="AUTHORIZATION: bearer $(System.AccessToken)" push azure --all
  #     git -c http.extraheader="AUTHORIZATION: bearer $(System.AccessToken)" push azure --tags
  #   displayName: 'Mirror all branches & tags (GitHub -> Azure DevOps)'
