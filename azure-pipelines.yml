
# azure-pipelines.yml
# CI on GitHub; authoritative sync to Azure DevOps using PAT and --force-with-lease
# with full history to avoid shallow object errors

trigger:
  branches:
    include:
      - master  # change to 'main' if your GitHub default branch is main

pr:
  branches:
    include:
      - master

pool:
  vmImage: 'ubuntu-latest'

variables:
  AZDO_ORG: 'LinetecDevelopment'
  AZDO_PROJECT: 'Resiliency%20-%20Development'
  AZDO_REPO: 'Generate-Weekly-PDFs-DSR-Resiliency'

steps:
  # 1) Checkout from GitHub with FULL history
  - checkout: self
    persistCredentials: true
    fetchDepth: 0  # <-- critical: avoid shallow clone

  # 2) Configure Git identity & add Azure DevOps remote (no credentials in URL)
  - script: |
      set -eu
      git config --global user.name "Azure Pipelines"
      git config --global user.email "buildagent@azuredevops.local"

      AZDO_URL="https://dev.azure.com/$(AZDO_ORG)/$(AZDO_PROJECT)/_git/$(AZDO_REPO)"

      if git remote | grep -q '^azure$'; then
        git remote set-url azure "$AZDO_URL"
      else
        git remote add azure "$AZDO_URL"
      fi

      echo "Azure remote set to:"
      printf '%s\n' "$AZDO_URL"
    displayName: 'Configure Git identity & Azure DevOps remote'

  # 3) Prepare PAT-based HTTP Basic header (safer than embedding PAT in URL)
  - script: |
      set -eu
      BASIC="$(printf ':%s' "$(AZDO_PAT)" | base64 -w0 || printf ':%s' "$(AZDO_PAT)" | base64)"
      echo "AUTHORIZATION: Basic $BASIC" > ~/.azdo_header
      chmod 600 ~/.azdo_header
      echo "Prepared PAT header for Azure DevOps pushes."
    displayName: 'Prepare PAT header for Azure DevOps'

  # 4) Authoritative sync for default branch using --force-with-lease
  - script: |
      set -eu

      # Make sure branch exists locally and is up to date with GitHub
      git fetch origin --prune
      # If master isn't present locally yet, create it tracking origin/master
      git checkout master || git checkout -b master origin/master
      git pull --ff-only origin master

      # (If the checkout was shallow for any reason, unshallow now)
      if [ -f .git/shallow ]; then
        echo "Converting shallow clone to full clone..."
        git fetch --unshallow origin
      fi

      # Seed lease: fetch current Azure state to ensure we don't overwrite concurrent changes
      EXTRA="AUTHORIZATION: $(cat ~/.azdo_header | cut -d' ' -f2-)"
      git -c http.extraheader="$EXTRA" fetch azure master

      # Safer force push: only forces if remote hasn't changed since our fetch
      git -c http.extraheader="$EXTRA" push --force-with-lease azure master:master
    displayName: 'Mirror GitHub → Azure DevOps (default branch, safer force)'

  # 5) OPTIONAL: Full mirror (all branches & tags) with --force-with-lease
  # - script: |
  #     set -eu
  #     git fetch origin --prune --tags
  #
  #     # Ensure full history for tags/branches as well
  #     if [ -f .git/shallow ]; then
  #       git fetch --unshallow origin
  #     fi
  #
  #     EXTRA="AUTHORIZATION: $(cat ~/.azdo_header | cut -d' ' -f2-)"
  #     git -c http.extraheader="$EXTRA" fetch azure --all --tags
  #     git -c http.extraheader="$EXTRA" push --force-with-lease azure --all
  #     git -c http.extraheader="$EXTRA" push --force-with-lease azure --tags
  #   displayName: 'Mirror all branches & tags (GitHub → Azure, safer force)'

  # 6) OPTIONAL: Diagnostics when troubleshooting
  # - script: |
  #     set -eu
  #     echo "Remotes:"
  #     git remote -v | sed 's/https:\/\/[^ ]*/https:\/\/<redacted>/g'
  #     echo "HEAD:"
  #     git symbolic-ref --short HEAD || echo "(detached)"
  #     EXTRA="AUTHORIZATION: $(cat ~/.azdo_header | cut -d' ' -f2-)"
  #     echo "Azure refs (ls-remote):"
  #     git -c http.extraheader="$EXTRA" ls-remote azure | head || true
  #   displayName: 'Diagnostics: remotes, HEAD, azure refs'
